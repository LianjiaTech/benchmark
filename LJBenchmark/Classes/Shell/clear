#!/bin/bash

#Copyright(c) 2019 Lianjia, Inc. All Rights Reserved
#Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
#associated documentation files (the "Software"), to deal in the Software without restriction,
#including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,
#and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do
#so, subject to the following conditions:
#
#The above copyright notice and this permission notice shall be included in all copies or substantial
#portions of the Software.
#
#THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
#IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
#FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
#THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
#OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
#ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
#OTHER DEALINGS IN THE SOFTWARE.

# å¿«æ·é”®ç”Ÿæˆçš„ä»£ç æ–‡ä»¶ç¼“å­˜
snip_cache_file_array=()

# ç¨‹åºå…¥å£
function main() {
    if [ ! $1 ]
    then
        help $@
    elif [ $1 = "--help" ]
    then
        help $@
    elif [ $1 = "--desc" ]
    then
        description $@
    else
        # è¿™é‡Œæ˜¯ä½ çš„åŠŸèƒ½å¤„ç†é€»è¾‘
        dispose $@
fi
}

# å¸®åŠ©
function help() {
    echo $outputPrefix"sh benchmark clear [file/dir/podspecs_name] [--snip/--method/--all]"
    echo $outputPrefix"å¸è½½æˆ‘ä»¬çš„ç—•è¿¹ä½¿ç”¨ï¼Œåˆ†ä¸ºæ–¹æ³•è€—æ—¶å…³è”ã€Podfileã€äº‹ä»¶æµä»£ç "
    echo $outputPrefix"clearæ“ä½œä¸­ \"sh benchmark clear [file/dir/podspecs_name] --snip\" ä¸ºæ¸…ç† [source] è·¯å¾„ä¸‹çš„å¿«æ·é”®ç”Ÿæˆçš„äº‹ä»¶æµä»£ç ç—•è¿¹"
    echo $outputPrefix"clearæ“ä½œä¸­ \"sh benchmark clear [file/dir/podspecs_name] --method\" ä¸ºæ¸…ç† [source] è·¯å¾„ä¸‹æ–¹æ³•è€—æ—¶å…³è”"
    echo $outputPrefix"clearæ“ä½œä¸­ \"sh benchmark clear [file/dir/podspecs_name] --all\" æ‰€æœ‰ç—•è¿¹"
    echo $outputPrefix"[source] æ”¯æŒä»¥ç©ºæ ¼ä½œä¸ºåˆ†éš”ç¬¦è¿›è¡Œå¤šä¸ªç›®æ ‡ä¸šåŠ¡è·¯å¾„åŒæ—¶è¿›è¡Œå–æ¶ˆå…³è”"
    echo $outputPrefix"å–æ¶ˆå…³è”å®Œæ¯•ï¼Œå®Œåå¹¶ä¸ºæ‚¨è‡ªåŠ¨æ‰“å¼€å·¥ä½œé¡¹ç›®"
    echo $outputPrefix"æ¬¢è¿æ‚¨çš„ä½¿ç”¨"
}

# æè¿°
function description() {
    echo $outputPrefix"ç»„ä»¶åç§°ï¼š\"clear\""
    echo $outputPrefix"åŠŸèƒ½ç®€ä»‹ï¼šè¿™ä¸ªç»„ä»¶æ˜¯ç”¨æ¥æ¸…ç†LJBenchmarkåœ¨æ‚¨çš„ä¸šåŠ¡ç—•è¿¹ä¸­ä½¿ç”¨çš„"
    echo $outputPrefix"ç‰ˆæœ¬å·ï¼š0.0.1"
    echo $outputPrefix"ä½œè€…ï¼šé“¾å®¶"
    echo "\n"
}

# å¤„ç†é€»è¾‘
function dispose() {
    last_parma=${!#}
    if [ $1 = "--snip" ]||[ $1 = "--method" ]||[ $1 = "--all" ]
    then
        echo $outputPrefix"æ‚¨åº”è¯¥è¾“å…¥ä¸€ä¸ª [source] è·¯å¾„"
        help $@
    else
        if [ $last_parma = "--snip" ]
        then
            clear_snip_code_related $@
        elif [ $last_parma = "--method" ]
        then
            clear_method_related $@
        elif [ $last_parma = "--all" ]
        then
            clear_all_related $@
        else
            echo $outputPrefix"å°†ä¸ºæ‚¨æŒ‰ç…§""sh benchmark clear $@ --method æ‰§è¡Œ"
            echo $outputPrefix"å‘½ä»¤è¡Œè¾“å…¥""sh benchmark clear --help æŸ¥çœ‹æ›´å¤šæ¸…ç†åŠŸèƒ½å¿«æ·é”®"
            clear_method_related $@
        fi
        # é‡æ–°è£…è½½é¡¹ç›®
        execute_pod_command $1
        # æ‰“å¼€é¡¹ç›®
        find_and_open_workspace_path
    fi
}

# æ¸…ç†è¾“å…¥æºä¸‹çš„æ–¹æ³•è€—æ—¶å…³è”
function clear_method_related() {
    start=$(date +%s.%N)
    echo $outputPrefix"å¼€å§‹æ¸…ç†æ–¹æ³•è€—æ—¶å…³è”"
    idx=0
    for i in "$@";
    do
        idx=$(expr $idx + 1)
        if [ $idx -gt 0 ]
        then
            if [ $i != "--snip" ]&&[ $i != "--method" ]&&[ $i != "--all" ]
            then
                clear_method_in_input_source $i
            fi
        fi
    done
    end=$(date +%s.%N)
    runtime=$(get_execution_time $start $end)
    echo $outputPrefix"æ¸…ç†æ–¹æ³•è€—æ—¶å…³è”ç»“æŸï¼Œç´¯è®¡è€—æ—¶ï¼š$runtime"
}

# æ¸…ç†è¾“å…¥æºä¸‹çš„æ–¹æ³•è€—æ—¶å…³è”
function clear_snip_code_related() {
    echo $outputPrefix"å¼€å§‹æ¸…ç†äº‹ä»¶æµä»£ç ç—•è¿¹"
    # æ‰§è¡Œæ‰«æç±»å‡½æ•°-è„šæœ¬æ‰§è¡Œåˆå§‹æ—¶é—´
    start=$(date +%s.%N)
    #####################################
    # 2ã€å°è¯•å¤„ç†è¾“å…¥å‚æ•°ä¸‹æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„ç±»
    echo $outputPrefix`date +'%Y-%m-%d %H:%M:%S'`" å¼€å§‹æ‰§è¡Œå¸è½½ä¸šåŠ¡å…³è”æ“ä½œï¼Œç›¸å¯¹è€—æ—¶^_^ï¼Œè€å¿ƒç­‰å¾… ğŸ˜† ~"
    # æ‰§è¡Œæ‰«æç±»å‡½æ•°å•ä¸ªä¸šåŠ¡è·¯å¾„è€—æ—¶ç»Ÿè®¡
    idx=0
    for i in "$@";
    do
        idx=$(expr $idx + 1)
        if [ $idx -gt 0 ]
        then
            if [ $i != "--snip" ]&&[ $i != "--method" ]&&[ $i != "--all" ]
            then
                clear_snip_code_in_input_source $i
            fi
        fi
    done

    #####################################
    # æ‰§è¡Œæ‰«æç±»å‡½æ•°-è„šæœ¬æ€»è€—æ—¶ç»Ÿè®¡
    end=$(date +%s.%N)
    runtime=$(get_execution_time $start $end)
    echo $outputPrefix`date +'%Y-%m-%d %H:%M:%S'`" å¸è½½ä¸šåŠ¡å…³è”æµç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå…³è”æ€»è®¡è€—æ—¶: $runtime"
}

# æ¸…ç†è¾“å…¥æºä¸‹çš„æ–¹æ³•è€—æ—¶å…³è”
function clear_all_related() {
    find_delete_benchmark_in_your_app_podfile
    clear_method_related $@
    clear_snip_code_related $@
}

# æ¸…ç†è¾“å…¥æºçš„æ–¹æ³•è€—æ—¶å…³è”
function clear_method_in_input_source() {
    file_name=$1
    if [ -d $1 ]&&[[ $1 =~ "/" ]]
    then
        temp=$1
        temp=${temp##*/}
        temp=${temp%%.*}
        file_name="LJBM""_auto_dir_""$temp"
    elif [ -f $1 ]
    then
        temp=$1
        temp=${temp##*/}
        temp=${temp%%.*}
        file_name="LJBM""_auto_file_""$temp"
    else
        file_name="LJBM""_auto_pod_""$1"
    fi

    file_path=$benchmark_classes_path"/Temp/""$file_name"".m"
    if [ -f $file_path ]
    then
        rm -f $file_path
    fi
    echo $outputPrefix"$1" "æ–¹æ³•è€—æ—¶å…³è”è§£é™¤"
}

# æ¸…é™¤äº‹ä»¶æµå¿«æ·é”®ç”Ÿæˆçš„è€—æ—¶ä»£ç å¹¶åˆ é™¤
function clear_snip_code_in_input_source() {
    sub_start=$(date +%s.%N)
    snip_cache_file_array=()
    if [ -d $1 ]&&[[ $1 =~ "/" ]]
    then
        echo $outputPrefix"å‚æ•° \"$1\" å°†æŒ‰ç…§ \"æ–‡ä»¶å¤¹\" ç±»å‹è¾“å…¥è¿›è¡Œå¸è½½å¤„ç†";
        #####################################
        # ç›´æ¥æ‰«ææ–‡ä»¶å¤¹ï¼Œå¾—åˆ°ç±»
        clear_benchmark_snippets_code_in_xc_project_dir $1
    elif [ -f $1 ]
    then
        echo $outputPrefix"å‚æ•° $1 å°†æŒ‰ç…§ \"æ–‡ä»¶\" ç±»å‹è¾“å…¥è¿›è¡Œå¸è½½å¤„ç†";
        #####################################
        # ç›´æ¥æ‰«ææ–‡ä»¶ï¼Œå¾—åˆ°ç±»
        find_benchmark_snippets_code_in_xc_project_file $1
    else
        echo $outputPrefix"ä¼ å…¥çš„å‚æ•° $1 å°†æŒ‰ç…§ \"podspec_name\" ç±»å‹è¾“å…¥è¿›è¡Œå¸è½½å¤„ç†";
        # æ‰¾åˆ°pofileæ‰¾åˆ°scanner_dir_path
        scanner_dir_path=`sh "${benchmark_shell_path}/pod" $1 "--source"`
        #####################################
        # æ‰§è¡Œæ‰«æç±»å‡½æ•°
        if [[ "$scanner_dir_path" = $__return_none__ ]]
        then
            echo $outputPrefix"å½“å‰ \"$1\" å‚æ•°ä»£è¡¨çš„ä¸šåŠ¡ä¸å±äºæ‚¨çš„å³å°†ç›‘æ§çš„å·¥ç¨‹ï¼ŒğŸ˜† ~"
        else
            echo $outputPrefix"å‚æ•° \"${1}\" æŒ‡å¼•ä¸‹æ‰¾åˆ°ä¸šåŠ¡ä»£ç ï¼š\"$scanner_dir_path\""
            # æ‰§è¡Œæ‰«æç±»å‡½æ•°
            if [[ -d $scanner_dir_path ]]
            then
                clear_benchmark_snippets_code_in_xc_project_dir $scanner_dir_path  # $1ä¼ å…¥çš„æ–‡ä»¶ä»£ç è·¯å¾„
            fi
        fi
    fi

    for element in ${snip_cache_file_array[@]}
    do
        clear_benchmark_snippets_code_in_xc_project_file $element
    done

    end=$(date +%s.%N)
    runtime=$(get_execution_time $sub_start $end)
    echo $outputPrefix"\"$1\" æ¸…ç†äº‹ä»¶æµä»£ç ç—•è¿¹ï¼Œè€—æ—¶: "$runtime
}

# æ‰¾åˆ°pofileä¸­çš„ benchmark ç›¸å…³çš„å†…å®¹ï¼Œå¹¶åˆ é™¤
function find_delete_benchmark_in_your_app_podfile() {
    # podfile_file_path=$root_path"/"Podfile
    temp_num=0
    while read line
    do
        temp_num=$(expr $temp_num + 1)
        if [[ $line =~ ^pod.* ]]&&[[ $line =~ "LJBenchmark" ]]
        then
            sed -i '' ${temp_num}d "$podfile_file_path"
            temp_num=$(expr $temp_num - 1)
        fi
    done <$podfile_file_path
    echo $outputPrefix"Podfileä¸­ç›¸å…³ä¾èµ–å·²æ¸…é™¤"
}

# æ¸…é™¤æ–‡ä»¶å¤¹è·¯å¾„ä¸‹çš„æ‰€æœ‰äº‹ä»¶æµæ–‡ä»¶
function clear_benchmark_snippets_code_in_xc_project_dir() {
    for file in `ls $1` # æ³¨æ„æ­¤å¤„è¿™æ˜¯ä¸¤ä¸ªåå¼•å·ï¼Œè¡¨ç¤ºè¿è¡Œç³»ç»Ÿå‘½ä»¤
    do
        if [ -d $1"/"$file ] # æ³¨æ„æ­¤å¤„ä¹‹é—´ä¸€å®šè¦åŠ ä¸Šç©ºæ ¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™
        then
            if [[ $file =~ "." ]]||[[ $file =~ "Pods" ]]
            then
                continue
            else
                clear_benchmark_snippets_code_in_xc_project_dir $1"/"$file
            fi
        else
            find_benchmark_snippets_code_in_xc_project_file $1"/"$file
        fi
    done
}

# æ¸…é™¤æ–‡ä»¶è·¯å¾„ä¸‹çš„æ‰€æœ‰äº‹ä»¶æµæ–‡ä»¶
function find_benchmark_snippets_code_in_xc_project_file(){
    file_path=$@
    suffix="${file_path##*.}"x
    if [ $suffix = "h"x ]||[ $suffix = "m"x ]||[ $suffix = "mm"x ]
    then
        start_str="#if __has_include(\"LJBenchmark.h\")"
        start_prefix="#if"
        while read line
        do
            if [[ $line =~ ^"$start_prefix".* ]]
            then
                if [[ $line =~ ^"$start_str".* ]]
                then
                    count=${#snip_cache_file_array[@]}
                    snip_cache_file_array[$count]=$file_path
                fi
            fi
        done <$file_path
    fi
}

# æ¸…é™¤æ–‡ä»¶è·¯å¾„ä¸‹çš„æ‰€æœ‰äº‹ä»¶æµæ–‡ä»¶
function clear_benchmark_snippets_code_in_xc_project_file(){
    file_path=$@
    suffix="${file_path##*.}"x
    if [ $suffix = "h"x ]||[ $suffix = "m"x ]||[ $suffix = "mm"x ]
    then
        start_line_num=0
        end_line_num=0
        start_str="#if __has_include(\"LJBenchmark.h\")"
        start_prefix="#if"
        end_str="#endif"
        temp_num=0
        while read line
        do
            temp_num=$(expr $temp_num + 1)
            if [[ $line =~ ^"$start_prefix".* ]]
            then
                if [[ $line =~ ^"$start_str".* ]]
                then
                    start_line_num=$temp_num
                fi
            fi

            if [[ $start_line_num -ne 0 ]]
            then
                if [[ $line =~ ^"$end_str".* ]]
                then
                    end_line_num=$temp_num
                    sed -i '' "${start_line_num},${end_line_num}d" "$file_path"
                    temp_num=$(expr $temp_num - 1 + $start_line_num - $end_line_num)
                    start_line_num=0
                    end_line_num=0
                fi
            fi
        done <$file_path
    fi
}

# æ‰§è¡Œpod å‘½ä»¤æ›´æ–°å£³å·¥ç¨‹
function execute_pod_command() {
    echo $outputPrefix"LJBenchmarkå·²ç»ä¸å¯¹åº”ä¸šåŠ¡å–æ¶ˆå…³è”ï¼Œå³å°† install é¡¹ç›®ï¼ŒæˆåŠŸå°†è‡ªåŠ¨å¸®æ‚¨æ‰“å¼€é¡¹ç›®"
    cd $root_path
    pod cache clean 'LJBenchmark' --all
    pod install
    xcodebuild clean -quiet
}

# æ‰¾åˆ°å·¥ä½œè·¯å¾„
function find_and_open_workspace_path() {
    xcworkspace_path=""
    for file in `ls $root_path`
    do
        if [[ $file =~ ".xcworkspace" ]]
        then
            xcworkspace_path=$file
        break
        fi
    done
    echo ${outputPrefix}"é“¾å®¶ï¼Œç¥æ‚¨å·¥ä½œæ„‰å¿«ï¼"
    cd $root_path
    open ./$xcworkspace_path
}

# è€—æ—¶è¿‡ç¨‹è®¡ç®—
function get_execution_time() {
    start=$1
    end=$2
    start_s=$(echo $start | cut -d '.' -f 1)
    end_s=$(echo $end | cut -d '.' -f 1)
    time=$(( ( 10#$end_s - 10#$start_s ) ))
    echo "$time s"
}


# æ‰§è¡Œè„šæœ¬
main $@
