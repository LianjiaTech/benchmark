#!/bin/bash

#Copyright(c) 2019 Lianjia, Inc. All Rights Reserved
#Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
#associated documentation files (the "Software"), to deal in the Software without restriction,
#including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,
#and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do
#so, subject to the following conditions:
#
#The above copyright notice and this permission notice shall be included in all copies or substantial
#portions of the Software.
#
#THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
#IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
#FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
#THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
#OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
#ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
#OTHER DEALINGS IN THE SOFTWARE.

hook_prefix="[allClsSet addObject:@\""
hook_suffix="\"];"
cls_list=""
colon=":"

# ç¨‹åºå…¥å£
function main() {
    if [ ! $1 ]
    then
        help $@
    elif [ $1 = "--help" ]
    then
        help $@
    elif [ $1 = "--desc" ]
    then
        description $@
    else
        # è¿™é‡Œæ˜¯ä½ çš„åŠŸèƒ½å¤„ç†é€»è¾‘
        dispose $@
    fi
}

# å¸®åŠ©
function help() {
    echo $outputPrefix"sh benchmark connect [file/dir/podspecs_name]"" ï¼Œè£…è½½æˆ‘ä»¬çš„æ’ä»¶ä½¿ç”¨"
    echo $outputPrefix"sh benchmark connect æ–‡ä»¶è·¯å¾„ æ–‡ä»¶å¤¹è·¯å¾„ podspecs_name ï¼Œ æ”¯æŒä»¥ç©ºæ ¼ä½œä¸ºåˆ†éš”ç¬¦è¿›è¡Œå¤šä¸ªç›®æ ‡ä¸šåŠ¡è·¯å¾„åŒæ—¶è¿›è¡Œå…³è”"
    echo $outputPrefix"podspecs_nameæ˜¯ AFNetworking è¿™æ ·çš„Podåº“åï¼Œæ¨èä½¿ç”¨"
    echo $outputPrefix"å…³è”å®Œæ¯•ï¼Œä¼šæ‰§è¡Œ pod install å¸®æ‚¨å®‰è£…å¥½ä¾èµ–ï¼Œä¾èµ–å…³è”å®Œæ¯•å¹¶ä¸ºæ‚¨è‡ªåŠ¨æ‰“å¼€å·¥ä½œé¡¹ç›®"
    echo $outputPrefix"å…³è”å®Œæ¯•ï¼Œå¦‚æœä¸æƒ³é‡æ–° pod install é¡¹ç›®ï¼Œä½¿ç”¨ sh benchmark connect [file/dir/podspecs_name] --noupdate "
    echo $outputPrefix"æ¬¢è¿æ‚¨çš„ä½¿ç”¨"
}

# æè¿°
function description() {
    echo $outputPrefix"ç»„ä»¶åç§°ï¼š\"connect\""
    echo $outputPrefix"åŠŸèƒ½ç®€ä»‹ï¼šè¿™ä¸ªç»„ä»¶æ˜¯ç”¨æ¥é“¾æ¥LJBenchmarkå’Œæ‚¨çš„ä¸šåŠ¡ä½¿ç”¨çš„"
    echo $outputPrefix"ç‰ˆæœ¬å·ï¼š0.0.1"
    echo $outputPrefix"ä½œè€…ï¼šé“¾å®¶"
    echo "\n"
}

# å¤„ç†é€»è¾‘
function dispose() {
    # åˆ é™¤tempçš„ç¼“å­˜ï¼Œé˜²æ­¢åˆ«çš„ä¸šåŠ¡çº¿å¹²æ‰°
    static_dir=$benchmark_classes_path"/Temp"
    if [ ! -d $static_dir ];
    then
        mkdir $static_dir
    else
        rm -rf $static_dir
        mkdir $static_dir
    fi

    last_parma=${!#}
    # 1ã€è£…è½½æˆ–è€…æ›´æ–°å¿«æ·é”®
    install_code_snippets_to_xc
    # 2ã€æ‰¾åˆ°pofile å¹¶æ·»åŠ ä¿®æ”¹pod
    sh "${benchmark_shell_path}/pod" "--podfile"
    #####################################
    # æ‰§è¡Œæ‰«æç±»å‡½æ•°-è„šæœ¬æ‰§è¡Œåˆå§‹æ—¶é—´
    start=$(date +%s.%N)
    echo $outputPrefix`date +'%Y-%m-%d %H:%M:%S'`" å¼€å§‹æ‰§è¡Œä¸šåŠ¡å…³è”æ“ä½œ"
    #####################################
    # 2ã€å°è¯•å¤„ç†è¾“å…¥å‚æ•°ä¸‹æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„ç±»
    # æ‰§è¡Œæ‰«æç±»å‡½æ•°å•ä¸ªä¸šåŠ¡è·¯å¾„è€—æ—¶ç»Ÿè®¡
    idx=0
    for i in "$@";
    do
        idx=$(expr $idx + 1)
        if [ $idx -gt 0 ]
        then
            if [ $i != "--noupdate" ]
            then
                try_relate_benchmark_and_inputparma $i
            fi
        fi
    done
    #####################################
    # 3ã€æ‰§è¡Œæ‰«æç±»å‡½æ•°-è„šæœ¬æ€»è€—æ—¶ç»Ÿè®¡
    end=$(date +%s.%N)
    runtime=$(get_execution_time $start $end)
    echo $outputPrefix`date +'%Y-%m-%d %H:%M:%S'`" ä¸šåŠ¡å…³è”æµç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå…³è”æ€»è®¡è€—æ—¶: $runtime"
    #####################################
    # 4ã€æ‰§è¡Œpodç›¸å…³æ“ä½œ
    if [ $last_parma = "--noupdate" ]
    then
        echo $outputPrefix"å³å°†ä¸ºæ‚¨æ‰“å¼€å·¥ç¨‹é¡¹ç›®~"
    else
        execute_pod_command $1
        echo $outputPrefix"å…³è”å®Œæ¯•ï¼Œå¦‚æœä¸æƒ³é‡æ–° pod install é¡¹ç›®ï¼Œä½¿ç”¨ sh benchmark connect [file/dir/podspecs_name] --noupdate "
    fi
    #####################################

    # 5ã€æ‰“å¼€é¡¹ç›®
    find_and_open_workspace_path

}

# è£…è½½å¿«æ·é”®åˆ°xcodeä¸­
function install_code_snippets_to_xc() {
    snippets_lc_path=$root_path"/../LJBenchmark/LJBenchmark/CodeSnippets"
    copy_aDir_files_to_another_dir $snippets_lc_path $snippets_xcode_path
    echo $outputPrefix"ç›¸å…³å¿«æ·é”®å·²å…³è”åˆ°Xcodeï¼Œç¼–å†™é¡¹ç›®æ—¶è¾“å…¥ \"LJBM_MAKE_\" å³å¯è·å¾—æç¤ºï¼Œé¦–æ¬¡å®‰è£…æˆ–æ–°çš„æ›´æ–°éœ€è¦é‡å¯Xcodeæ‰èƒ½ç”Ÿæ•ˆã€‚"
    echo $outputPrefix"ç§»é™¤ä½¿ç”¨ \"sh benchmark clear --snip\" or \"sh benchmark clear\""
}

# å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶å¤¹å†…æ–‡ä»¶å»å¦å¤–ä¸€ä¸ªæ–‡ä»¶å¤¹
function copy_aDir_files_to_another_dir() {
    fm_dir=$1
    to_dir=$2
    if [ -d $fm_dir ]&&[ -d $to_dir ]
    then
        for  file in `ls $fm_dir`
        do
            if [ -f $to_dir"/"$file ]
            then
                rm -f $to_dir"/"$file
            fi
            cp $fm_dir"/"$file $to_dir"/"$file
        done
    fi
}

# å°è¯•æ‰«æå‡ºè¾“å…¥å‚æ•°è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»
function try_relate_benchmark_and_inputparma() {
    sub_start=$(date +%s.%N)
    cls_list=""
    suffix_name=`find_parameter_input_suffix_name $1`
    if [ -d $1 ]&&[[ $1 =~ "/" ]]
    then
        echo $outputPrefix"å‚æ•° \"$1\" å°†æŒ‰ç…§ \"æ–‡ä»¶å¤¹\" ç±»å‹è¾“å…¥è¿›è¡Œå¤„ç†";
        # ç›´æ¥æ‰«ææ–‡ä»¶å¤¹ï¼Œå¾—åˆ°ç±»
        scanner_cls_in_dir $1
        # å°†æ‰«æçš„ç»“æœå†™å…¥benchmark_shell_path æ–‡ä»¶å¤¹ä¸­
        if [[ $cls_list ]]
        then
            write_scanner_cls_to_benchmark_pod $suffix_name
        else
            echo $outputPrefix"å‚æ•° \"$1\" æ–‡ä»¶å¤¹ä¸­æœªå…³è”åˆ°ç±»";
        fi
    elif [ -f $1 ]
    then
        echo $outputPrefix"å‚æ•° $1 å°†æŒ‰ç…§ \"æ–‡ä»¶\" ç±»å‹è¾“å…¥è¿›è¡Œå¤„ç†";
        # ç›´æ¥æ‰«ææ–‡ä»¶ï¼Œå¾—åˆ°ç±»
        scanner_cls_in_file $1
        # å°†æ‰«æçš„ç»“æœå†™å…¥benchmark_shell_path æ–‡ä»¶å¤¹ä¸­
        if [[ $cls_list ]]
        then
            write_scanner_cls_to_benchmark_pod $suffix_name
        else
            echo $outputPrefix"å‚æ•° \"$1\" æ–‡ä»¶ä¸­æœªå…³è”åˆ°ç±»";
        fi
    else
        echo $outputPrefix"ä¼ å…¥çš„å‚æ•° $1 å°†æŒ‰ç…§ \"podspec_name\" ç±»å‹è¾“å…¥è¿›è¡Œå¤„ç†";
        # æ‰¾åˆ°pofileæ‰¾åˆ°scanner_dir_path
        scanner_dir_path=`sh "${benchmark_shell_path}/pod" $1 "--source"`
        #####################################
        # æ‰§è¡Œæ‰«æç±»å‡½æ•°
        if [[ "$scanner_dir_path" = $__return_none__ ]]
        then
            echo $outputPrefix"å½“å‰ \"$1\" å‚æ•°ä»£è¡¨çš„ä¸šåŠ¡ä¸å±äºæ‚¨çš„å³å°†ç›‘æ§çš„å·¥ç¨‹ï¼ŒğŸ˜† ~"
        else
            echo $outputPrefix"å‚æ•° \"${1}\" æŒ‡å¼•ä¸‹æ‰¾åˆ°ä¸šåŠ¡ä»£ç ï¼š\"$scanner_dir_path\""
            scanner_cls_in_dir $scanner_dir_path  # $1ä¼ å…¥çš„æ–‡ä»¶ä»£ç è·¯å¾„
            # å°†æ‰«æçš„ç»“æœå†™å…¥benchmark_shell_path æ–‡ä»¶å¤¹ä¸­
            if [[ $cls_list ]]
            then
                write_scanner_cls_to_benchmark_pod $suffix_name $1
            else
                echo $outputPrefix"å‚æ•° \"$1\" Podä¸­æœªå…³è”åˆ°ç±»";
            fi
        fi
    fi

    end=$(date +%s.%N)
    runtime=$(get_execution_time $sub_start $end)
    echo $outputPrefix"\"$1\" æµç¨‹ï¼Œè€—æ—¶: "$runtime
}

# æ‰¾åˆ°å‚æ•°è¾“å…¥çš„å°¾ç¼€åç§°
function find_parameter_input_suffix_name() {
    if [ -d $1 ]&&[[ $1 =~ "/" ]]
    then
        temp=$1
        temp=${temp##*/}
        temp=${temp%%.*}
        echo "LJBM""_auto_dir_""$temp"
    elif [ -f $1 ]
    then
        temp=$1
        temp=${temp##*/}
        temp=${temp%%.*}
        echo "LJBM""_auto_file_""$temp"
    else
        echo "LJBM""_auto_pod_""$1"
    fi
}

# éå†æ–‡ä»¶å¤¹æ‰¾åˆ°ç›¸å…³çš„ç±»
function scanner_cls_in_dir() {
    for file in `ls $1` # æ³¨æ„æ­¤å¤„è¿™æ˜¯ä¸¤ä¸ªåå¼•å·ï¼Œè¡¨ç¤ºè¿è¡Œç³»ç»Ÿå‘½ä»¤
    do
        if [ -d $1"/"$file ] # æ³¨æ„æ­¤å¤„ä¹‹é—´ä¸€å®šè¦åŠ ä¸Šç©ºæ ¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™
        then
            if [[ $file =~ "." ]]||[[ $file =~ "Pods" ]]
            then
                continue
            else
                scanner_cls_in_dir $1"/"$file
            fi
        else
            scanner_cls_in_file $1"/"$file
        fi
    done
}

# éå†æ–‡ä»¶çš„è¡Œæ‰¾åˆ°ç±»
function scanner_cls_in_file () {
    file_path=$@
    suffix="${file_path##*.}"x
    if [ $suffix = "h"x ]||[ $suffix = "m"x ]||[ $suffix = "mm"x ]
    then
        while read line
        do
            if [[ $line =~ ^@interface.* ]]
            then
                cls=$line
                cls=${cls#*@interface}
                if [[ $cls == *$colon* ]]
                then
                    cls=${cls%%:*}
                    cls=`echo $cls`
                    cls_list=$cls_list"\t"$hook_prefix""$cls""$hook_suffix"\n"
                fi
            fi
        done <$file_path
    fi
}



# æ‰¾åˆ° LJBenchmark ä»“åº“å†™å…¥Shell ç±»
function write_scanner_cls_to_benchmark_pod() {
    static_dir=$benchmark_classes_path"/Temp"
    if [ ! -d $static_dir ];
    then
        mkdir $static_dir
    fi

    lib_name=$1
    if [ $2 ]
    then
        lib_name=$2
    fi

    # XC_benchmark_shell å‰ç¼€
    xc_asterisk="*"
    xc_prefix="//""\n""//  XC_benchmark_shell.m""\n""//  LJBenchmark""\n""//""\n""//  Created by Chengjie on 2019/11/28.""\n""//  Copyright Â© 2019 lianjia. All rights reserved.""\n""//  Authors : Mingtingfeng, Wangnan, Chengjie""\n""//""\n\n""#if __has_include(\"LJBenchmark.h\")""\n""\n""#if DEBUG""\n\n""#import \"LJBenchmark.h\"""\n\n""__attribute__((constructor(101))) void ljnh_benchmark_load_${1}() {""\n""\t""NSMutableDictionary *info = [NSMutableDictionary dictionary];""\n""\t""[[LJBenchmark getHookBusinessesInfo] addObject:info];""\n""\t""[info setObject:[NSMutableDictionary dictionary] forKey:kLJBenchmarkLogLibNameKey];""\n""\t""[info setObject:[NSMutableSet set] forKey:kLJBenchmarkLogLibClassesKey];""\n""\n""\t""NSMutableDictionary *libInfo = [info objectForKey:kLJBenchmarkLogLibNameKey];""\n""\t""[libInfo setObject:@\"${lib_name}\" forKey:@\"libname\"];""\n""\t""[libInfo setObject:@\"1.0.0\" forKey:@\"libversion\"];""\n""\t""\n""\t""NSDictionary *infoDictionary = [[NSBundle mainBundle] infoDictionary];""\n""\t""NSString *appName = [infoDictionary objectForKey:@\"CFBundleDisplayName\"];""\n""\t""NSStringÂ *appBuildVersionÂ =Â [infoDictionaryÂ objectForKey:@\"CFBundleVersion\"];""\n""\t""[libInfo setObject:appName forKey:@\"appname\"];""\n""\t""[libInfo setObject:appBuildVersion forKey:@\"appversion\"];""\n""\n""\t""NSMutableSet<NSString *> *allClsSet = [info objectForKey:kLJBenchmarkLogLibClassesKey];""\n\n"

    # XC_benchmark_shell åç¼€
    xc_middle="\t""for (NSString *obj in allClsSet) {""\n\t\t""LJBM_HOOK_CLASS(NSClassFromString(obj));""\n\t""}""\n\n"
    xc_suffix="}\n\n""@interface ${1} : NSObject""\n\n""@end""\n\n""@implementation ${1}""\n\n""@end""\n\n""#endif""\n\n""#endif""\n\n"
    echo $xc_prefix""$cls_list""$xc_middle""$xc_suffix > $static_dir"/""$1"".m"
}

# æ‰§è¡Œpod å‘½ä»¤æ›´æ–°å£³å·¥ç¨‹
function execute_pod_command() {
    echo $outputPrefix"LJBenchmarkå·²ç»ä¸å¯¹åº”ä¸šåŠ¡å…³è”ï¼Œå³å°† install æ¥å…¥é¡¹ç›®ä¸­ï¼Œæ¥å…¥æˆåŠŸå°†è‡ªåŠ¨å¸®æ‚¨æ‰“å¼€é¡¹ç›®"
    cd $root_path
    pod cache clean 'LJBenchmark' --all
    pod install
    xcodebuild clean -quiet
}

# æ‰¾åˆ°å·¥ä½œè·¯å¾„
function find_and_open_workspace_path() {
    xcworkspace_path=""
    for file in `ls $root_path`
    do
        if [[ $file =~ ".xcworkspace" ]]
        then
            xcworkspace_path=$file
        break
        fi
    done
    echo ${outputPrefix}"é“¾å®¶ï¼Œç¥æ‚¨å·¥ä½œæ„‰å¿«ï¼"
    cd $root_path
    open ./$xcworkspace_path
}

# è€—æ—¶è¿‡ç¨‹è®¡ç®—
function get_execution_time() {
    start=$1
    end=$2
    start_s=$(echo $start | cut -d '.' -f 1)
    end_s=$(echo $end | cut -d '.' -f 1)
    time=$(( ( 10#$end_s - 10#$start_s ) ))
    echo "$time s"
}

# æ‰§è¡Œè„šæœ¬
main $@
